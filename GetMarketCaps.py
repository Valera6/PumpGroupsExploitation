import json, pprint, time
pp = pprint.PrettyPrinter()
import requests
import numpy as np
from requests import Request, Session
from requests.exceptions import ConnectionError, Timeout, TooManyRedirects

with open("allTickers.json") as f:
    symbols = json.load(f)

url = 'https://pro-api.coinmarketcap.com/v1/cryptocurrency/quotes/latest'
headers = {
  'Accepts': 'application/json',
  'X-CMC_PRO_API_KEY': '0537352d-28d7-4911-8870-4740497ef800',
}
session = Session()
session.headers.update(headers)


exceptions = ['ERSDL', 'ETH2']
market_caps = {}
for i, symbol in enumerate(symbols):
    continue_ = False
    if symbol in exceptions:
        print(f"skipped -{symbol}-")
        continue
    params = {
      'symbol': symbol,
      'convert':'USD'
    }
    print(symbol)
    try:
        data = session.get(url, params=params).json()
        while data['status']['error_code'] != 0:
            print(data['status']['error_message'])
            if "Invalid value" in data['status']['error_message']:
                exceptions.append(symbol)
                print(exceptions)
                continue_ = True
                break
            time.sleep(20)
            data = session.get(url, params=params).json()
        if continue_ is True:
            continue
        market_cap = round(data['data'][f'{symbol}']['quote']['USD']['market_cap'])
        market_caps[f"{symbol}"] = market_cap

        print(i, market_cap)
        time.sleep(2)
    except:
        print(f'add {symbol} to exceptions')
with open("MarketCaps.json", "w") as f:
    json.dump(market_caps, f)
