from pprint import pprint
import requests, time
import pandas as pd

from kucoin.client import Market
client = Market(key='63550bfbdeb3bb0001c11a06', secret='8ce27752-86ab-4f02-b6cd-0e4ca44aadf6', passphrase='Passphrase', url='https://api.kucoin.com')

def get_price(symbol):
        r = requests.get(f'https://api.kucoin.com/api/v1/market/orderbook/level1?symbol={symbol.upper()}-USDT').json()
        return float(r['data']['price'])

def get_asks(symbol):
    book = client.get_aggregated_orderv3(f'{symbol}-USDT')
    return book['asks']
    #size is quoted in relation to the base ticker

def check(symbol):
        try:
                asks = get_asks(symbol)
                total_nominal = 0
                total_actual = 0
                actual_price = get_price(symbol)
                tp_target_cluster = 0

                to_print = []
                for order in asks:
                    price = float(order[0])
                    size  = float(order[1])
                    
                    total_nominal += price*size
                    total_actual += actual_price*size

                    if actual_price*1.75 < price < actual_price*2.005:
                        if price*size > 1000:
                                to_print.append(order)
                        tp_target_cluster += price*size
                    
                    if price >= actual_price*6:
                        break

                if tp_target_cluster/total_nominal >= 0.18:
                        for line in to_print:
                            print(line)
                        print(symbol)
                        print(round(total_nominal))
                        print(round(total_actual))
                        print(total_nominal/total_actual)
                        print(tp_target_cluster/total_nominal)
                        printed.append(symbol)
                        print('----------------------------')
        except:
                pass
        time.sleep(0.1)

target_tickers = pd.read_csv('rigidTickerSelection.csv', sep = ';')
printed = []
while True:
        for ticker in target_tickers['Tickers']:
                if not ticker in printed:
                        check(ticker)
        print('end_of_cycle')
print('finished')
