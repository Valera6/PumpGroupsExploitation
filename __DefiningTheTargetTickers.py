import json, requests
import pandas as pd
# blocks warning from trying to modify a copy of a df
pd.options.mode.chained_assignment = None  # default='warn'

with open('MarketCaps.json') as f:
    symbols = json.load(f)

adequate_dict = {'Tickers':[], 'Caps':[]}
for symbol in symbols:
    adequate_dict['Tickers'].append(symbol)
    adequate_dict['Caps'].append(symbols[symbol])

df = pd.DataFrame.from_dict(adequate_dict)
df = df.set_index('Caps')
target_tickers = df.loc[2100000:]

def get_av_volume(symbol):
    symbol = symbol+'USDT'
    r = requests.get(f"https://www.cryptodatadownload.com/cdd/Kucoin_{symbol}_d.csv")

    d30 = []
    for i, line in enumerate(r.iter_lines()):
        if i>1:
            line = line.decode('utf-8')
            split = line.split(',')
            d30.append(float(split[-1]))
        if i>31:
            break
    return sum(d30)/30


av_volumes = []
prices = []
for i, ticker in enumerate(target_tickers['Tickers']):
    av_volumes.append(round(get_av_volume(ticker)))
    try:
        r = requests.get(f'https://api.kucoin.com/api/v1/market/orderbook/level1?symbol={ticker}-USDT').json()
        prices.append(r['data']['price'])
    except:
        try:
            r = requests.get(f'https://api.kucoin.com/api/v1/market/orderbook/level1?symbol={ticker}-BTC').json()['data']['price']
            btcPrice = requests.get(f'https://api.kucoin.com/api/v1/market/orderbook/level1?symbol=BTC-USDT').json()['data']['price']
            prices.append(float(r)*round(float(btcPrice)))
        except:
            prices.append(0)
    print(f'{i+1}/{len(target_tickers["Tickers"])}')

target_tickers['30dAvVolume'] = av_volumes
target_tickers['Price'] = prices
target_tickers.to_csv('TargetTickers.csv')
